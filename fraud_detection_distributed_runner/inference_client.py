from datetime import datetime

import numpy as np
import pandas as pd
from bentoml.client import Client

test_transactions: pd.DataFrame = pd.read_csv("./data/test_transaction.csv")[:500]

sample_json = test_transactions.to_dict(orient="records")

client = Client.from_url("http://localhost:13000")

latency_list = []

for _ in range(50):
    t = datetime.now()
    res = client.call("is_fraud", test_transactions)
    tt = datetime.now() - t
    latency_list.append(tt.total_seconds())

print(f"AVG: {sum(latency_list)/ len(latency_list)}")
print(f"Median: {np.median(sorted(latency_list,reverse=True))}")
print("percentile: ", np.percentile(latency_list, [0, 25, 50, 75, 100], interpolation='nearest'))
print(latency_list)
# origin AVG: 0.16650568000000013 (166.5ms)
print(res)


# AVG: 0.17835424666666663
# Median: 0.16778
# [0.232951, 0.170607, 0.204711, 0.240432, 0.201617, 0.258193, 0.161768, 0.165917, 0.173057, 0.195095, 0.178169, 0.183358, 0.173401, 0.15664, 0.194838, 0.161007, 0.165908, 0.200097, 0.161669, 0.204012, 0.172238, 0.213896, 0.17911, 0.160901, 0.160483, 0.167685, 0.196508, 0.164473, 0.206508, 0.184038, 0.181063, 0.171169, 0.166544, 0.203727, 0.203551, 0.197045, 0.164248, 0.160431, 0.169995, 0.165075, 0.19635, 0.202269, 0.165244, 0.161309, 0.163258, 0.166406, 0.162294, 0.211627, 0.164243, 0.162454, 0.171941, 0.197802, 0.200188, 0.161465, 0.172017, 0.16319, 0.208329, 0.196597, 0.198521, 0.166031, 0.163537, 0.179091, 0.160653, 0.201006, 0.166095, 0.21519, 0.165047, 0.160156, 0.210585, 0.165367, 0.199341, 0.162457, 0.163075, 0.163275, 0.200299, 0.165877, 0.166453, 0.195931, 0.166306, 0.166327, 0.165401, 0.195592, 0.16531, 0.167891, 0.198497, 0.213802, 0.162754, 0.166235, 0.166744, 0.165394, 0.1613, 0.214802, 0.166973, 0.177113, 0.261837, 0.185005, 0.162722, 0.210165, 0.159383, 0.161273, 0.201566, 0.196852, 0.163102, 0.163774, 0.164121, 0.200738, 0.198198, 0.160446, 0.162349, 0.163277, 0.210053, 0.213733, 0.174824, 0.157057, 0.162562, 0.199275, 0.180422, 0.217661, 0.160277, 0.165139, 0.198914, 0.160535, 0.162643, 0.161367, 0.158739, 0.165771, 0.206057, 0.196008, 0.163426, 0.15875, 0.213438, 0.173834, 0.196545, 0.170272, 0.162461, 0.160766, 0.203713, 0.161962, 0.197044, 0.200849, 0.162391, 0.168948, 0.169111, 0.168109, 0.197618, 0.161607, 0.164284, 0.159501, 0.208662, 0.198352, 0.161803, 0.162303, 0.168868, 0.161308, 0.198432, 0.160964, 0.168643, 0.201418, 0.195624, 0.163994, 0.159645, 0.162891, 0.169332, 0.207057, 0.196549, 0.168742, 0.168149, 0.16782, 0.200351, 0.172823, 0.158168, 0.196548, 0.180383, 0.162104, 0.163546, 0.160836, 0.200345, 0.199278, 0.199409, 0.163378, 0.168183, 0.192908, 0.172109, 0.159907, 0.168012, 0.164713, 0.198724, 0.173535, 0.19503, 0.164485, 0.160082, 0.196724, 0.162947, 0.167054, 0.161209, 0.197881, 0.166849, 0.159645, 0.163502, 0.203092, 0.169006, 0.163186, 0.198228, 0.163672, 0.203378, 0.160464, 0.162733, 0.159806, 0.194998, 0.163526, 0.195416, 0.165443, 0.162781, 0.196584, 0.198331, 0.161555, 0.161738, 0.160307, 0.160842, 0.164309, 0.194978, 0.201048, 0.162492, 0.175036, 0.160734, 0.201721, 0.171234, 0.199558, 0.158314, 0.196629, 0.164131, 0.170942, 0.159585, 0.162505, 0.197323, 0.167498, 0.163143, 0.192768, 0.160289, 0.164401, 0.166972, 0.198086, 0.161401, 0.198203, 0.199494, 0.162968, 0.157937, 0.163507, 0.207314, 0.161419, 0.199491, 0.165485, 0.158367, 0.159512, 0.166493, 0.201328, 0.198092, 0.164625, 0.161592, 0.166682, 0.157269, 0.205054, 0.192927, 0.199458, 0.165714, 0.161466, 0.164677, 0.164779, 0.166833, 0.202282, 0.200866, 0.160267, 0.163498, 0.162536, 0.163059, 0.194505, 0.209388, 0.157913, 0.162302, 0.161963, 0.208713, 0.16538, 0.164123, 0.198746, 0.167776, 0.2085, 0.200835, 0.174096, 0.168699, 0.166558, 0.16778, 0.159902, 0.207606, 0.161523, 0.174231, 0.199745, 0.160024, 0.209075, 0.176135, 0.168135]


# origin batch-size=250
# AVG: 0.16136390000000003
# Median: 0.151199
# [0.316258, 0.220483, 0.225128, 0.209743, 0.205748, 0.145872, 0.149909, 0.147098, 0.1493, 0.186811, 0.154662, 0.157381, 0.150217, 0.146996, 0.197608, 0.155946, 0.151758, 0.199523, 0.183496, 0.1547, 0.151323, 0.184627, 0.147374, 0.145839, 0.154226, 0.160517, 0.148717, 0.208032, 0.155149, 0.154799, 0.154652, 0.145803, 0.18457, 0.183463, 0.148635, 0.148635, 0.150656, 0.149261, 0.149973, 0.150263, 0.18167, 0.186282, 0.151132, 0.147319, 0.184888, 0.148751, 0.179334, 0.145607, 0.147333, 0.149929, 0.145963, 0.149787, 0.149849, 0.14993, 0.204719, 0.151849, 0.163263, 0.218088, 0.150272, 0.185471, 0.149093, 0.146387, 0.146665, 0.155118, 0.148324, 0.180398, 0.179661, 0.146703, 0.156516, 0.148198, 0.185699, 0.147843, 0.148989, 0.146077, 0.189841, 0.146412, 0.146451, 0.180876, 0.148249, 0.147628, 0.147325, 0.149478, 0.183765, 0.147099, 0.1453, 0.140083, 0.184952, 0.144968, 0.186079, 0.145089, 0.147197, 0.147718, 0.152227, 0.147672, 0.158483, 0.190836, 0.188802, 0.156909, 0.15216, 0.147441, 0.182336, 0.185131, 0.153973, 0.148426, 0.146146, 0.145661, 0.181342, 0.147038, 0.14647, 0.148002, 0.190098, 0.151283, 0.145721, 0.145354, 0.183919, 0.155158, 0.14702, 0.155231, 0.184963, 0.180618, 0.147054, 0.14844, 0.151305, 0.18685, 0.145778, 0.150029, 0.150161, 0.145379, 0.148554, 0.144705, 0.146243, 0.180852, 0.18283, 0.15216, 0.146589, 0.185324, 0.149881, 0.146913, 0.152173, 0.184861, 0.147785, 0.146653, 0.147122, 0.148571, 0.144648, 0.190079, 0.151399, 0.194734, 0.13792, 0.149263, 0.181337, 0.205751, 0.144327, 0.146233, 0.149463, 0.153528, 0.14632, 0.146976, 0.18071, 0.186678, 0.150483, 0.151199, 0.147951, 0.152915, 0.146268, 0.183517, 0.186728, 0.149335, 0.150024, 0.149775, 0.147853, 0.182015, 0.150139, 0.185077, 0.152325, 0.146882, 0.158333, 0.147148, 0.144846, 0.152002, 0.188494, 0.146959, 0.146916, 0.152359, 0.182725, 0.147669, 0.15114, 0.151302, 0.186131, 0.14727, 0.190057, 0.150891, 0.186897, 0.153864, 0.18558, 0.149704, 0.150243, 0.148844, 0.18428, 0.152556, 0.152903, 0.152164, 0.149534, 0.152863, 0.148883, 0.153517, 0.188642, 0.15071, 0.14488, 0.148392, 0.190626, 0.184509, 0.148412, 0.148585, 0.149589, 0.184596, 0.14958, 0.152317, 0.150559, 0.176906, 0.186154, 0.153827, 0.146933, 0.148988, 0.153386, 0.149082, 0.150018, 0.146987, 0.184656, 0.155066, 0.14768, 0.185088, 0.150044, 0.186095, 0.147945, 0.149405, 0.187239, 0.152229, 0.154199, 0.152883, 0.181153, 0.148906, 0.141459, 0.150689, 0.175908, 0.150244, 0.148491, 0.145483, 0.156676, 0.183536, 0.185744, 0.147779, 0.149084, 0.181913, 0.151612, 0.148221, 0.151403, 0.14861, 0.145589, 0.189881, 0.186915, 0.195029, 0.149894, 0.147913, 0.152082, 0.151968, 0.15193, 0.147591, 0.187034, 0.150052, 0.149797, 0.15017, 0.184468, 0.150836, 0.188453, 0.186168, 0.149095, 0.152089, 0.147356, 0.188663, 0.197036, 0.14984, 0.147269, 0.151597, 0.153322, 0.187298, 0.150345, 0.15305, 0.153375, 0.219852, 0.148869, 0.151948, 0.148899, 0.15255, 0.149031, 0.151042, 0.184583, 0.182397, 0.166024, 0.151426]

# origin batch-size=500
# AVG: 0.230375546
# Median: 0.24064
# percentile:  [0.201651 0.214071 0.221728 0.244495 0.424819]

# dis-runner batch-size=500
# AVG: 0.24146625600000002
# Median: 0.256292
# percentile:  [0.21139  0.226784 0.233077 0.258906 0.379564]